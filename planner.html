<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrected Fixed-Width Deadline-based Grad School Admission Timeline Planner</title>
    <style>
        :root {
            --white: #fff;
            --divider: lightgrey;
            --body: #f5f7f8;
            --deadline: #8B0000;
            --text: #000000;
        }
        
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        
        ul {
            list-style: none;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        body {
            background: var(--body);
            font-size: 16px;
            font-family: sans-serif;
            padding-top: 40px;
        }
        
        .chart-wrapper {
            width: 1000px;
            padding: 0 10px;
            margin: 0 auto;
            position: relative;
        }
        
        .chart-values {
            position: relative;
            display: flex;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .chart-values li {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .chart-values li span {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--body);
            padding: 0 5px;
            z-index: 2;
        }
        
        .chart-values li:not(:last-child)::before {
            content: '';
            position: absolute;
            right: 0;
            height: 510px;
            border-right: 1px solid var(--divider);
        }
        
        .chart-bars li {
            position: absolute;
            height: 20px;
            background-color: transparent;
            border-radius: 10px;
            transition: all 0.65s linear 0.2s;
            overflow: visible;
            white-space: nowrap;
        }
        
        .chart-bars li::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            border-radius: 10px;
        }
        
        .chart-bars li span {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text);
            z-index: 2;
        }
        
        .page-footer {
            font-size: 0.85rem;
            padding: 11px;
            text-align: center;
            color: var(--black);
            opacity: 0.5;
            display: none;
        }
        
        .page-footer span {
            color: #e31b23;
        }

        .deadline {
            position: absolute;
            top: 0px;
            display: flex;
            flex-direction: column;
            min-width: 110px;
            align-items: center;
            z-index: 10;
        }

        .deadline img {
            width: 30px;
            height: 30px;
        }

        .deadline-line {
            position: absolute;
            top: 0;
            bottom: 0;
            margin-top:25px;
            border-left: 2px dashed var(--deadline);
            z-index: 5;
        }

        .deadline-text {
            font-size: 0.6rem;
            color: black;
            margin-top: 2px;
        }

        .timeline-text {
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="chart-wrapper">
        <ul class="chart-values">
            <!-- Months will be dynamically inserted here -->
        </ul>
        <ul class="chart-bars">
            <li data-duration="0.5" data-color="#f2b134" data-progress="90">Pemilihan Beasiswa</li>
            <li data-duration="0.5" data-color="#da6f2b" data-progress="90">Pemilihan Program</li>
            <li data-duration="1." data-color="#f16666" data-progress="35">Statement of Purpose</li>
            <li data-duration="1." data-color="#928ff3" data-progress="50">Surat Rekomendasi</li>
            <li data-duration="1." data-color="#6f8ffb" data-progress="75">Transkrip & Ijazah</li>
            <li data-duration="1." data-color="#4cc2f0" data-progress="90">Resume/CV</li>
            <li data-duration="1.5." data-color="#81c469" data-progress="50">Tes TOEFL IBT</li>
            <li data-duration="1." data-color="#6ef388" data-progress="80">Tes GRE</li>
            <li data-duration="0.8" data-color="#34f91d" data-progress="4">Pengisian Formulir</li>
        </ul>
        <div class="deadline">
            <img  src="/assets/icons/stanford.ico" alt="Stanford Icon">
            <span class="deadline-text">Submission Deadline</span>
            <span class="deadline-text">(Stanford MCIM, R1)</span>
            <span id="deadline-date" class="deadline-text"></span>
        </div>
        <div class="deadline-line"></div>
    </div>
    <footer class="page-footer">
        <small>Made with <span>‚ù§</span> by MyKampus Planner</small>
    </footer>

    <script>
        function getStartWeekDay(date) {
            const dayOfWeek = date.getDay();
            const daysToMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1); // If Sunday, move back 6 days
            const mondayDate = new Date(date);
            mondayDate.setDate(date.getDate() - daysToMonday);
            return mondayDate;
        }

        function getDaysInMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        }

        function monthDiff(d1, d2) {
            let years = d2.getFullYear() - d1.getFullYear();
            let months = d2.getMonth() - d1.getMonth();
            let days = d2.getDate();
        
            let totalMonths = years * 12 + months + days / getDaysInMonth(d2);
        
            return Math.max(0, totalMonths);
        }


        const monthNames = [
            "Jan", "Feb", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        ];

        function createChart() {
            const deadlineDate = new Date("2024-11-15");//new Date(document.getElementById('deadlineDate').value);
            const chartValues = document.querySelector(".chart-values");
            const tasks = document.querySelectorAll(".chart-bars li");
            const deadline = document.querySelector(".deadline");
            const deadlineLine = document.querySelector(".deadline-line");

            const isCompacted = true;

            // Clear existing month labels
            chartValues.innerHTML = '';

            console.log("Deadline date: ", deadlineDate);

            let totalDuration = 0;
            tasks.forEach(task => {
                const duration = parseFloat(task.dataset.duration);
                const progress = parseFloat(task.dataset.progress);
                if(isCompacted) {
                    totalDuration += duration*(1-progress/100);
                } else {
                    totalDuration += duration;
                }
            });
            // console.log("Total duration: ", totalDuration); 

            let startDate = new Date(deadlineDate);
            startDate.setMonth(startDate.getMonth() - totalDuration);
            startDate = getStartWeekDay(startDate);

            const monthCount = Math.ceil(totalDuration) + 1;
            // console.log("Month count: ", monthCount);

            // Create month labels
            for (let i = 0; i < monthCount; i++) {
                const monthDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                // console.log("Month date: ", monthDate);
                const li = document.createElement('li');
                li.innerHTML = `<span>${monthNames[monthDate.getMonth()]}</span>`;
                chartValues.appendChild(li);

                // Add month divider
                if (i <= monthCount - 1) {
                    const halfMonthDivider = document.createElement('li');
                    halfMonthDivider.style.flexGrow = '0';
                    halfMonthDivider.style.position = 'relative';
                    halfMonthDivider.innerHTML = '<div style="position: absolute; top: 20px; bottom: 0; width: 1px; background-color: var(--divider); left: 50%;"></div>';
                    chartValues.appendChild(halfMonthDivider);
                }
            }

            const totalWidth = 980; // Fixed width minus padding
            const monthWidth = totalWidth / monthCount;
            

            let currentStartDate = new Date(deadlineDate);
            let currentEndDate = new Date(deadlineDate);
            let numtasks = tasks.length;
            for (let index = tasks.length - 1; index >= 0; index--) {
                const el = tasks[index];
                const duration = parseFloat(el.dataset.duration);
                const progress = parseFloat(el.dataset.progress);                

                // Calculate start date for this task
                if (isCompacted) {
                    remaining_duration = duration*(1-progress/100);                    
                } else {
                    remaining_duration = duration;
                }
                // console.log("Remaining duration: ", remaining_duration);
                currentStartDate = new Date(currentEndDate - remaining_duration * 30 * 24 * 60 * 60 * 1000);
                currentStartDate = getStartWeekDay(currentStartDate);
                // console.log(el.textContent);
                // console.log("Current start date: ", currentStartDate);
                // console.log("Current end date: ", currentEndDate);                
                
                const startMonth = monthDiff(startDate, currentStartDate);                
                const left = startMonth * monthWidth;
                const width = duration * monthWidth;
                currentEndDate = new Date(currentStartDate);

                el.style.left = `${left}px`;
                el.style.width = `${width}px`;
                el.style.top = `${40 + index * 30}px`;
                el.style.border = `2px solid ${el.dataset.color}`;

                // Add progress bar filled from the right and overlay the title
                el.innerHTML = `
                    <div style="position: absolute; top: 0; right: 0; height: 100%; width: ${progress}%; background-color: ${el.dataset.color}; border-radius: 8px;"></div>
                    <span class="timeline-text">${el.textContent}</span>
                `;
            };

            // Position deadline at the end
            deadline_left = monthDiff(startDate, deadlineDate) * monthWidth;
            deadline.style.left = `${3+deadline_left}px`;
            deadline.style.top = `${40 + tasks.length * 30}px`;            
            deadlineLine.style.left = `${deadline_left}px`;
            deadlineLine.style.height = `${chartValues.offsetHeight + (tasks.length + 1) * 40}px`;
        }

        // Add deadline input to the page
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.id = 'deadlineDate';
        dateInput.style.display = 'none';
        dateInput.value = new Date().toISOString().split('T')[0]; // Set default to today
        document.body.insertBefore(dateInput, document.querySelector('.chart-wrapper'));

        dateInput.addEventListener('change', createChart);
        window.addEventListener("load", createChart);
        window.addEventListener("resize", createChart);
    </script>
</body>
</html>